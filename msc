#!/bin/bash

# GitHub repository information
GITHUB_REPO="HelluPeptic/linux_msc"
VERSION_FILE="/usr/local/bin/.msc_version"
INSTALL_DIR="/usr/local/bin"

# Function to get current version (commit hash)
get_current_version() {
    if [ -f "$VERSION_FILE" ]; then
        cat "$VERSION_FILE"
    else
        echo "unknown"
    fi
}

# Function to check for updates
check_for_updates() {
    dialog --infobox "Checking for updates..." 8 40
    
    local current_version=$(get_current_version)
    local temp_file="/tmp/msc_updates"
    local found_updates=false
    
    # Clear temp file
    > "$temp_file"
    
    # Get latest commits from each branch
    for branch in "main" "QoL-updates" "dev" "experimental"; do
        # Get latest commit from this branch
        local latest_commit=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits/$branch" 2>/dev/null | grep -o '"sha": "[^"]*"' | head -1 | sed 's/"sha": "\([^"]*\)"/\1/')
        
        # Skip if we couldn't get the commit
        if [ -z "$latest_commit" ]; then
            continue
        fi
        
        # If version is unknown or different from current, show it as an update
        if [ "$current_version" = "unknown" ] || [ "$latest_commit" != "$current_version" ]; then
            # Get commit info
            local commit_info=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits/$latest_commit" 2>/dev/null)
            if [ $? -eq 0 ] && [ -n "$commit_info" ]; then
                local commit_message=$(echo "$commit_info" | grep -o '"message": "[^"]*"' | head -1 | sed 's/"message": "\([^"]*\)"/\1/' | cut -c1-50)
                local commit_date=$(echo "$commit_info" | grep -o '"date": "[^"]*"' | head -1 | sed 's/"date": "\([^"]*\)"/\1/')
                
                # Format date nicely
                local display_date=$(date -d "$commit_date" "+%b %d, %Y" 2>/dev/null || echo "Recent")
                
                # Add to updates file
                echo "$latest_commit|$commit_message|$branch|$display_date" >> "$temp_file"
                found_updates=true
            fi
        fi
    done
    
    if [ "$found_updates" = false ] || [ ! -s "$temp_file" ]; then
        dialog --msgbox "You're up to date!\\n\\nNo newer updates available.\\n\\nCurrent version: ${current_version:0:8}" 10 50
        rm -f "$temp_file"
        return
    fi
    
    # Show available updates
    show_update_menu "$temp_file"
    rm -f "$temp_file"
}

# Function to show update selection menu
show_update_menu() {
    local updates_file="$1"
    local menu_items=()
    local commit_data=()
    local counter=1
    
    while IFS='|' read -r commit_hash commit_message branch display_date; do
        
        # Create user-friendly display with experimental marking and commit hash
        local short_hash="${commit_hash:0:8}"
        local display_text
        
        # Mark as experimental if branch is NOT main
        if [ "$branch" != "main" ]; then
            if [ -z "$commit_message" ] || [ "$commit_message" = "" ]; then
                display_text="[EXPERIMENTAL] Commit $short_hash ($display_date - $branch)"
            else
                display_text="[EXPERIMENTAL] $commit_message [$short_hash] ($display_date - $branch)"
            fi
        else
            if [ -z "$commit_message" ] || [ "$commit_message" = "" ]; then
                display_text="Commit $short_hash ($display_date - $branch)"
            else
                display_text="$commit_message [$short_hash] ($display_date - $branch)"
            fi
        fi
        
        menu_items+=("$counter" "$display_text")
        commit_data["$counter"]="$commit_hash|$commit_message|$branch"
        counter=$((counter + 1))
    done < "$updates_file"
    
    if [ ${#menu_items[@]} -eq 0 ]; then
        dialog --msgbox "No updates found." 8 40
        return
    fi
    
    local selection=$(dialog --menu "Available Updates:\n\nSelect an update to install:" 20 100 8 "${menu_items[@]}" 3>&1 1>&2 2>&3)
    
    if [ -n "$selection" ] && [ -n "${commit_data[$selection]}" ]; then
        IFS='|' read -r selected_commit selected_message selected_branch <<< "${commit_data[$selection]}"
        
        # Show confirmation dialog
        local branch_warning=""
        if [[ "$selected_branch" == *"EXPERIMENTAL"* ]]; then
            branch_warning="\n\n  WARNING: This is an experimental branch!\nIt may contain unstable features or bugs."
        fi
        
        # Clean branch name for display
        local clean_branch=$(echo "$selected_branch" | sed 's/ \[EXPERIMENTAL\]//')
        local branch_display="$clean_branch"
        
        if dialog --yesno "Install update?\n\nCommit: ${selected_commit:0:8}\nMessage: $selected_message\nBranch: $branch_display$branch_warning\n\nThis will update your msc installation." 15 70; then
            install_update "$selected_commit" "$clean_branch"
        fi
    fi
}

# Function to install update
install_update() {
    local commit_hash="$1"
    local branch="$2"
    local clean_branch=$(echo "$branch" | sed 's/ \[EXPERIMENTAL\]//')
    
    {
        echo "10" ; echo "Downloading update..."
        
        # Create temporary directory
        local temp_dir=$(mktemp -d)
        cd "$temp_dir" || exit 1
        
        echo "30" ; echo "Extracting files..."
        
        # Download the specific commit
        if ! curl -L -s "https://github.com/$GITHUB_REPO/archive/$commit_hash.tar.gz" | tar -xz; then
            dialog --msgbox "Failed to download update. Please check your internet connection." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "60" ; echo "Installing files..."
        
        # Find the extracted directory
        local extracted_dir=$(find . -maxdepth 1 -type d -name "*linux_msc*" | head -1)
        if [ -z "$extracted_dir" ]; then
            # Fallback: look for any directory that's not . or ..
            extracted_dir=$(ls -d */ 2>/dev/null | head -1 | sed 's|/$||')
        fi
        
        if [ -z "$extracted_dir" ]; then
            dialog --msgbox "Failed to extract update files." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "80" ; echo "Updating installation..."
        
        # Copy files to installation directory
        cd "$extracted_dir" || exit 1
        sudo cp -r * "$INSTALL_DIR/"
        
        # Make scripts executable
        sudo chmod +x "$INSTALL_DIR/msc" "$INSTALL_DIR/msc-servers.sh" "$INSTALL_DIR/msc-create.sh"
        sudo chmod +x "$INSTALL_DIR/create_scripts/"*.sh
        
        echo "95" ; echo "Saving version info..."
        
        # Save new version
        sudo bash -c "echo '$commit_hash' > '$VERSION_FILE'"
        
        echo "100" ; echo "Update complete!"
        
        # Cleanup
        cd /
        rm -rf "$temp_dir"
        
    } | dialog --gauge "Installing Update..." 10 60 0
    
    dialog --msgbox "Update installed successfully!\n\nNew version: ${commit_hash:0:8}\nBranch: $clean_branch\n\nPlease restart msc to use the new version." 12 60
}

# Function to display the menu
show_menu() {
    dialog --clear --title "Minecraft Server Control" --menu "Choose an option:" 17 55 3 \
        1 "Manage Minecraft Servers testtesttest" \
        2 "Create a New Minecraft Server" \
        3 "Check for Updates" 2> /tmp/msc_menu_choice

    local choice
    choice=$(< /tmp/msc_menu_choice)
    rm -f /tmp/msc_menu_choice

    case "$choice" in
        1)
            # Run the msc-servers.sh script
            bash msc-servers.sh
            ;;
        2)
            # Run the msc-create.sh script
            bash msc-create.sh
            ;;
        3)
            # Check for updates
            check_for_updates
            ;;
        *)
            # If cancelled or closed, do nothing
            clear
            echo "Exited menu."
            ;;
    esac
}

# Main execution
clear
show_menu
