#!/bin/bash

# GitHub repository information
GITHUB_REPO="HelluPeptic/linux_msc"
VERSION_FILE="/usr/local/bin/.msc_version"
INSTALL_DIR="/usr/local/bin"

# Function to get current version (commit hash)
get_current_version() {
    if [ -f "$VERSION_FILE" ]; then
        cat "$VERSION_FILE"
    else
        echo "unknown"
    fi
}

# Function to save current version
save_current_version() {
    local commit_hash="$1"
    echo "$commit_hash" > "$VERSION_FILE"
}

# Function to get GitHub commits for a branch
get_github_commits() {
    local branch="$1"
    local current_commit="$2"
    
    # Get commits from GitHub API
    local commits_json=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits?sha=$branch&per_page=10")
    
    if [ $? -ne 0 ] || [ -z "$commits_json" ]; then
        return 1
    fi
    
    # Parse commits and find newer ones
    echo "$commits_json" | grep -E '"sha":|"date":|"message":' | 
    while read -r line; do
        if echo "$line" | grep -q '"sha"'; then
            commit_hash=$(echo "$line" | sed 's/.*"sha": "\([^"]*\)".*/\1/')
            read -r date_line
            read -r message_line
            commit_date=$(echo "$date_line" | sed 's/.*"date": "\([^"]*\)".*/\1/')
            commit_message=$(echo "$message_line" | sed 's/.*"message": "\([^"]*\)".*/\1/' | cut -c1-60)
            
            # If this is a newer commit than current, output it
            if [ "$commit_hash" != "$current_commit" ]; then
                echo "$commit_hash|$commit_date|$commit_message|$branch"
            else
                break  # We've reached our current commit, no more newer ones
            fi
        fi
    done
}

# Function to check for updates
check_for_updates() {
    dialog --infobox "Checking for updates..." 8 40
    
    local current_version=$(get_current_version)
    local updates_found=false
    local temp_file="/tmp/msc_updates"
    
    # Clear temp file
    > "$temp_file"
    
    # Check main branch
    if get_github_commits "main" "$current_version" >> "$temp_file"; then
        updates_found=true
    fi
    
    # Check other branches (mark as experimental)
    for branch in "QoL-updates" "dev" "experimental"; do
        if get_github_commits "$branch" "$current_version" | sed "s/|$branch$/|$branch [EXPERIMENTAL]/" >> "$temp_file"; then
            updates_found=true
        fi
    done
    
    if [ ! -s "$temp_file" ]; then
        dialog --msgbox "No updates available.\n\nCurrent version: ${current_version:0:8}" 10 50
        rm -f "$temp_file"
        return
    fi
    
    # Show available updates
    show_update_menu "$temp_file"
    rm -f "$temp_file"
}

# Function to show update selection menu
show_update_menu() {
    local updates_file="$1"
    local menu_items=()
    local commit_data=()
    local counter=1
    
    while IFS='|' read -r commit_hash commit_date commit_message branch; do
        local display_date=$(date -d "$commit_date" "+%Y-%m-%d %H:%M" 2>/dev/null || echo "$commit_date")
        local display_text="${commit_hash:0:8} - $commit_message ($branch)"
        local display_info="$display_date"
        
        menu_items+=("$counter" "$display_text")
        commit_data["$counter"]="$commit_hash|$commit_message|$branch"
        counter=$((counter + 1))
    done < "$updates_file"
    
    if [ ${#menu_items[@]} -eq 0 ]; then
        dialog --msgbox "No updates found." 8 40
        return
    fi
    
    local selection=$(dialog --menu "Available Updates:\n\nSelect an update to install:" 20 80 10 "${menu_items[@]}" 3>&1 1>&2 2>&3)
    
    if [ -n "$selection" ] && [ -n "${commit_data[$selection]}" ]; then
        IFS='|' read -r selected_commit selected_message selected_branch <<< "${commit_data[$selection]}"
        
        # Show confirmation dialog
        local branch_warning=""
        if [[ "$selected_branch" == *"EXPERIMENTAL"* ]]; then
            branch_warning="\n\n  WARNING: This is an experimental branch!\nIt may contain unstable features or bugs."
        fi
        
        if dialog --yesno "Install update?\n\nCommit: ${selected_commit:0:8}\nMessage: $selected_message\nBranch: $selected_branch$branch_warning\n\nThis will update your msc installation." 15 70; then
            install_update "$selected_commit" "$selected_branch"
        fi
    fi
}

# Function to install update
install_update() {
    local commit_hash="$1"
    local branch="$2"
    local clean_branch=$(echo "$branch" | sed 's/ \[EXPERIMENTAL\]//')
    
    {
        echo "10" ; echo "Downloading update..."
        
        # Create temporary directory
        local temp_dir=$(mktemp -d)
        cd "$temp_dir" || exit 1
        
        echo "30" ; echo "Extracting files..."
        
        # Download the specific commit
        if ! curl -L -s "https://github.com/$GITHUB_REPO/archive/$commit_hash.tar.gz" | tar -xz; then
            dialog --msgbox "Failed to download update. Please check your internet connection." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "60" ; echo "Installing files..."
        
        # Find the extracted directory
        local extracted_dir=$(find . -maxdepth 1 -type d -name "*$GITHUB_REPO*" | head -1)
        if [ -z "$extracted_dir" ]; then
            dialog --msgbox "Failed to extract update files." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "80" ; echo "Updating installation..."
        
        # Copy files to installation directory
        cd "$extracted_dir" || exit 1
        sudo cp -r * "$INSTALL_DIR/"
        
        # Make scripts executable
        sudo chmod +x "$INSTALL_DIR/msc" "$INSTALL_DIR/msc-servers.sh" "$INSTALL_DIR/msc-create.sh"
        sudo chmod +x "$INSTALL_DIR/create_scripts/"*.sh
        
        echo "95" ; echo "Saving version info..."
        
        # Save new version
        sudo bash -c "echo '$commit_hash' > '$VERSION_FILE'"
        
        echo "100" ; echo "Update complete!"
        
        # Cleanup
        cd /
        rm -rf "$temp_dir"
        
    } | dialog --gauge "Installing Update..." 10 60 0
    
    dialog --msgbox "Update installed successfully!\n\nNew version: ${commit_hash:0:8}\nBranch: $clean_branch\n\nPlease restart msc to use the new version." 12 60
}

# Function to display the menu
show_menu() {
    dialog --clear --title "Minecraft Server Control" --menu "Choose an option:" 17 55 3 \
        1 "Manage Minecraft Servers" \
        2 "Create a New Minecraft Server" \
        3 "Check for Updates" 2> /tmp/msc_menu_choice

    local choice
    choice=$(< /tmp/msc_menu_choice)
    rm -f /tmp/msc_menu_choice

    case "$choice" in
        1)
            # Run the msc-servers.sh script
            bash msc-servers.sh
            ;;
        2)
            # Run the msc-create.sh script
            bash msc-create.sh
            ;;
        3)
            # Check for updates
            check_for_updates
            ;;
        *)
            # If cancelled or closed, do nothing
            clear
            echo "Exited menu."
            ;;
    esac
}

# Main execution
clear
show_menu
