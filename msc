#!/bin/bash

# GitHub repository information
GITHUB_REPO="HelluPeptic/linux_msc"
VERSION_FILE="/usr/local/bin/.msc_version"
INSTALL_DIR="/usr/local/bin"

# Function to get current version (commit hash)
get_current_version() {
    if [ -f "$VERSION_FILE" ]; then
        cat "$VERSION_FILE"
    else
        echo "unknown"
    fi
}

# Function to save current version
save_current_version() {
    local commit_hash="$1"
    echo "$commit_hash" > "$VERSION_FILE"
}

# Function to get current commit timestamp
get_current_commit_timestamp() {
    local current_commit="$1"
    if [ "$current_commit" = "unknown" ]; then
        echo "0"
        return
    fi
    
    # Get timestamp of current commit from GitHub API
    local commit_info=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits/$current_commit")
    if command -v jq >/dev/null 2>&1; then
        echo "$commit_info" | jq -r '.commit.author.date' 2>/dev/null || echo "0"
    else
        echo "$commit_info" | grep -o '"date": "[^"]*"' | head -n1 | sed 's/"date": "\([^"]*\"/\1/' || echo "0"
    fi
}

# Function to compare timestamps (returns 0 if first is newer than second)
compare_timestamps() {
    local timestamp1="$1"
    local timestamp2="$2"
    
    # Convert to seconds since epoch for comparison
    local time1=$(date -d "$timestamp1" +%s 2>/dev/null || echo "0")
    local time2=$(date -d "$timestamp2" +%s 2>/dev/null || echo "0")
    
    [ "$time1" -gt "$time2" ]
}

# Function to get current commit timestamp
get_current_commit_timestamp() {
    local current_commit="$1"
    if [ "$current_commit" = "unknown" ]; then
        echo "0"
        return
    fi
    
    # Get timestamp of current commit from GitHub API
    local commit_info=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits/$current_commit")
    if command -v jq >/dev/null 2>&1; then
        echo "$commit_info" | jq -r '.commit.author.date' 2>/dev/null || echo "0"
    else
        echo "$commit_info" | grep -o '"date": "[^"]*"' | head -n1 | sed 's/"date": "\([^"]*\)"/\1/' || echo "0"
    fi
}

# Function to compare timestamps (returns 0 if first is newer than second)
compare_timestamps() {
    local timestamp1="$1"
    local timestamp2="$2"
    
    # Convert to seconds since epoch for comparison
    local time1=$(date -d "$timestamp1" +%s 2>/dev/null || echo "0")
    local time2=$(date -d "$timestamp2" +%s 2>/dev/null || echo "0")
    
    [ "$time1" -gt "$time2" ]
}

# Function to get GitHub commits for a branch
get_github_commits() {
    local branch="$1"
    local current_commit="$2"
    
    # Get commits from GitHub API
    local commits_json=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits?sha=$branch&per_page=5")
    
    if [ $? -ne 0 ] || [ -z "$commits_json" ] || echo "$commits_json" | grep -q '"message": "Not Found"'; then
        return 1
    fi
    
    # Debug: Show ALL commits for now (remove current_commit check temporarily)
    echo "$commits_json" | grep -o '"sha": "[^"]*"' | head -3 | while read -r sha_line; do
        local sha=$(echo "$sha_line" | sed 's/"sha": "\([^"]*\)"/\1/')
        
        # Extract date and message for this commit
        local date=$(echo "$commits_json" | grep -A10 "\"sha\": \"$sha\"" | grep '"date":' | head -n1 | sed 's/.*"date": "\([^"]*\)".*/\1/')
        local message=$(echo "$commits_json" | grep -A5 "\"sha\": \"$sha\"" | grep '"message":' | head -n1 | sed 's/.*"message": "\([^"]*\)".*/\1/' | head -c50)
        
        echo "$sha|$date|$message|$branch"
    done
}

# Function to check for updates
check_for_updates() {
    # Check if jq is available for better JSON parsing
    if ! command -v jq >/dev/null 2>&1; then
        if dialog --yesno "For better update checking, we recommend installing 'jq'.\n\nInstall jq now? (requires sudo)" 10 60; then
            if sudo apt update && sudo apt install -y jq; then
                dialog --msgbox "jq installed successfully!" 8 40
            else
                dialog --msgbox "Failed to install jq. Update checking will still work but may be less reliable." 10 60
            fi
        fi
    fi
    
    dialog --infobox "Checking for updates..." 8 40
    
    local current_version=$(get_current_version)
    local updates_found=false
    local temp_file="/tmp/msc_updates"
    
    # Clear temp file
    > "$temp_file"
    
    # Debug: Show current version
    dialog --msgbox "Debug Info:\\n\\nCurrent version: $current_version\\n\\nThis will help debug the update detection." 12 60
    
    # If version is unknown, show all recent commits anyway for testing
    if [ "$current_version" = "unknown" ]; then
        current_version="dummy_hash_that_wont_match"
    fi
    
    # Check main branch
    if get_github_commits "main" "$current_version" >> "$temp_file"; then
        updates_found=true
    fi
    
    # Check other branches (mark as experimental)
    for branch in "QoL-updates" "dev" "experimental"; do
        if get_github_commits "$branch" "$current_version" | sed "s/|$branch$/|$branch [EXPERIMENTAL]/" >> "$temp_file"; then
            updates_found=true
        fi
    done
    
    if [ ! -s "$temp_file" ]; then
        dialog --msgbox "You're up to date!\\n\\nNo newer updates available.\\n\\nCurrent version: ${current_version:0:8}" 10 50
        rm -f "$temp_file"
        return
    fi
    
    # Show available updates
    show_update_menu "$temp_file"
    rm -f "$temp_file"
}

# Function to show update selection menu
show_update_menu() {
    local updates_file="$1"
    local menu_items=()
    local commit_data=()
    local counter=1
    
    while IFS='|' read -r commit_hash commit_date commit_message branch; do
        # Format the date nicely
        local display_date=$(date -d "$commit_date" "+%b %d, %Y" 2>/dev/null || echo "Recent")
        
        # Create user-friendly display with experimental marking
        local display_text
        if [[ "$branch" == *"EXPERIMENTAL"* ]]; then
            display_text="[EXPERIMENTAL] $commit_message ($display_date - $branch)"
        else
            display_text="$commit_message ($display_date - $branch)"
        fi
        
        menu_items+=("$counter" "$display_text")
        commit_data["$counter"]="$commit_hash|$commit_message|$branch"
        counter=$((counter + 1))
    done < "$updates_file"
    
    if [ ${#menu_items[@]} -eq 0 ]; then
        dialog --msgbox "No updates found." 8 40
        return
    fi
    
    local selection=$(dialog --menu "Available Updates:\n\nSelect an update to install:" 20 100 8 "${menu_items[@]}" 3>&1 1>&2 2>&3)
    
    if [ -n "$selection" ] && [ -n "${commit_data[$selection]}" ]; then
        IFS='|' read -r selected_commit selected_message selected_branch <<< "${commit_data[$selection]}"
        
        # Show confirmation dialog
        local branch_warning=""
        if [[ "$selected_branch" == *"EXPERIMENTAL"* ]]; then
            branch_warning="\n\n  WARNING: This is an experimental branch!\nIt may contain unstable features or bugs."
        fi
        
        # Clean branch name for display
        local clean_branch=$(echo "$selected_branch" | sed 's/ \[EXPERIMENTAL\]//')
        local branch_display="$clean_branch"
        
        if dialog --yesno "Install update?\n\nCommit: ${selected_commit:0:8}\nMessage: $selected_message\nBranch: $branch_display$branch_warning\n\nThis will update your msc installation." 15 70; then
            install_update "$selected_commit" "$clean_branch"
        fi
    fi
}

# Function to install update
install_update() {
    local commit_hash="$1"
    local branch="$2"
    local clean_branch=$(echo "$branch" | sed 's/ \[EXPERIMENTAL\]//')
    
    {
        echo "10" ; echo "Downloading update..."
        
        # Create temporary directory
        local temp_dir=$(mktemp -d)
        cd "$temp_dir" || exit 1
        
        echo "30" ; echo "Extracting files..."
        
        # Download the specific commit
        if ! curl -L -s "https://github.com/$GITHUB_REPO/archive/$commit_hash.tar.gz" | tar -xz; then
            dialog --msgbox "Failed to download update. Please check your internet connection." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "60" ; echo "Installing files..."
        
        # Find the extracted directory
        local extracted_dir=$(find . -maxdepth 1 -type d -name "*linux_msc*" | head -1)
        if [ -z "$extracted_dir" ]; then
            # Fallback: look for any directory that's not . or ..
            extracted_dir=$(ls -d */ 2>/dev/null | head -1 | sed 's|/$||')
        fi
        
        if [ -z "$extracted_dir" ]; then
            dialog --msgbox "Failed to extract update files." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "80" ; echo "Updating installation..."
        
        # Copy files to installation directory
        cd "$extracted_dir" || exit 1
        sudo cp -r * "$INSTALL_DIR/"
        
        # Make scripts executable
        sudo chmod +x "$INSTALL_DIR/msc" "$INSTALL_DIR/msc-servers.sh" "$INSTALL_DIR/msc-create.sh"
        sudo chmod +x "$INSTALL_DIR/create_scripts/"*.sh
        
        echo "95" ; echo "Saving version info..."
        
        # Save new version
        sudo bash -c "echo '$commit_hash' > '$VERSION_FILE'"
        
        echo "100" ; echo "Update complete!"
        
        # Cleanup
        cd /
        rm -rf "$temp_dir"
        
    } | dialog --gauge "Installing Update..." 10 60 0
    
    dialog --msgbox "Update installed successfully!\n\nNew version: ${commit_hash:0:8}\nBranch: $clean_branch\n\nPlease restart msc to use the new version." 12 60
}

# Function to display the menu
show_menu() {
    dialog --clear --title "Minecraft Server Control" --menu "Choose an option:" 17 55 3 \
        1 "Manage Minecraft Servers testtesttest" \
        2 "Create a New Minecraft Server" \
        3 "Check for Updates" 2> /tmp/msc_menu_choice

    local choice
    choice=$(< /tmp/msc_menu_choice)
    rm -f /tmp/msc_menu_choice

    case "$choice" in
        1)
            # Run the msc-servers.sh script
            bash msc-servers.sh
            ;;
        2)
            # Run the msc-create.sh script
            bash msc-create.sh
            ;;
        3)
            # Check for updates
            check_for_updates
            ;;
        *)
            # If cancelled or closed, do nothing
            clear
            echo "Exited menu."
            ;;
    esac
}

# Main execution
clear
show_menu
