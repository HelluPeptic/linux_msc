#!/bin/bash

# GitHub repository information
GITHUB_REPO="HelluPeptic/linux_msc"
VERSION_FILE="/usr/local/bin/.msc_version"
INSTALL_DIR="/usr/local/bin"

# Function to get current version (commit hash)
get_current_version() {
    if [ -f "$VERSION_FILE" ]; then
        cat "$VERSION_FILE"
    else
        echo "unknown"
    fi
}

# Function to save current version
save_current_version() {
    local commit_hash="$1"
    echo "$commit_hash" > "$VERSION_FILE"
}

# Function to get GitHub commits for a branch
get_github_commits() {
    local branch="$1"
    local current_commit="$2"
    
    # Get commits from GitHub API
    local commits_json=$(curl -s "https://api.github.com/repos/$GITHUB_REPO/commits?sha=$branch&per_page=5")
    
    if [ $? -ne 0 ] || [ -z "$commits_json" ] || echo "$commits_json" | grep -q '"message": "Not Found"'; then
        return 1
    fi
    
    # Use jq if available, otherwise use simple grep/sed parsing
    if command -v jq >/dev/null 2>&1; then
        echo "$commits_json" | jq -r '.[] | "\(.sha)|\(.commit.author.date)|\(.commit.message)|'$branch'"' | while IFS='|' read -r sha date message branch_name; do
            if [ "$sha" != "$current_commit" ]; then
                # Clean up the commit message (first line only, max 50 chars)
                clean_message=$(echo "$message" | head -n1 | cut -c1-50)
                echo "$sha|$date|$clean_message|$branch_name"
            else
                break
            fi
        done
    else
        # Simple fallback parsing using grep and sed
        local temp_commits="/tmp/commits_$$"
        echo "$commits_json" > "$temp_commits"
        
        # Extract commits one by one
        local commit_count=0
        while [ $commit_count -lt 5 ]; do
            local sha=$(grep -o '"sha": "[^"]*"' "$temp_commits" | head -n1 | sed 's/"sha": "\([^"]*\)"/\1/')
            [ -z "$sha" ] && break
            [ "$sha" = "$current_commit" ] && break
            
            local date=$(grep -A20 "\"sha\": \"$sha\"" "$temp_commits" | grep '"date":' | head -n1 | sed 's/.*"date": "\([^"]*\)".*/\1/')
            local message=$(grep -A10 "\"sha\": \"$sha\"" "$temp_commits" | grep '"message":' | head -n1 | sed 's/.*"message": "\([^"]*\)".*/\1/' | cut -c1-50)
            
            echo "$sha|$date|$message|$branch"
            
            # Remove this commit from temp file to get next one
            sed -i "/\"sha\": \"$sha\"/,/},/d" "$temp_commits"
            commit_count=$((commit_count + 1))
        done
        
        rm -f "$temp_commits"
    fi
}

# Function to check for updates
check_for_updates() {
    # Check if jq is available for better JSON parsing
    if ! command -v jq >/dev/null 2>&1; then
        if dialog --yesno "For better update checking, we recommend installing 'jq'.\n\nInstall jq now? (requires sudo)" 10 60; then
            if sudo apt update && sudo apt install -y jq; then
                dialog --msgbox "jq installed successfully!" 8 40
            else
                dialog --msgbox "Failed to install jq. Update checking will still work but may be less reliable." 10 60
            fi
        fi
    fi
    
    dialog --infobox "Checking for updates..." 8 40
    
    local current_version=$(get_current_version)
    local updates_found=false
    local temp_file="/tmp/msc_updates"
    
    # Clear temp file
    > "$temp_file"
    
    # If version is unknown, only check for the latest release on main branch
    if [ "$current_version" = "unknown" ]; then
        dialog --msgbox "This appears to be a development version or first install.\n\nFor development versions, please use git to update manually.\n\nIf this is a regular install, please reinstall from the latest release." 12 70
        rm -f "$temp_file"
        return
    fi
    
    # Check main branch
    if get_github_commits "main" "$current_version" >> "$temp_file"; then
        updates_found=true
    fi
    
    # Check other branches (mark as experimental)
    for branch in "QoL-updates" "dev" "experimental"; do
        if get_github_commits "$branch" "$current_version" | sed "s/|$branch$/|$branch [EXPERIMENTAL]/" >> "$temp_file"; then
            updates_found=true
        fi
    done
    
    if [ ! -s "$temp_file" ]; then
        dialog --msgbox "You're up to date! \u2713\n\nNo newer updates available.\n\nCurrent version: ${current_version:0:8}" 10 50
        rm -f "$temp_file"
        return
    fi
    
    # Show available updates
    show_update_menu "$temp_file"
    rm -f "$temp_file"
}

# Function to show update selection menu
show_update_menu() {
    local updates_file="$1"
    local menu_items=()
    local commit_data=()
    local counter=1
    
    while IFS='|' read -r commit_hash commit_date commit_message branch; do
        # Format the date nicely
        local display_date=$(date -d "$commit_date" "+%b %d, %Y" 2>/dev/null || echo "Recent")
        
        # Create user-friendly display
        local branch_label="$branch"
        if [[ "$branch" == *"EXPERIMENTAL"* ]]; then
            branch_label="⚠️  $branch"
        fi
        
        local display_text="$commit_message"
        local display_info="$display_date - $branch_label"
        
        menu_items+=("$counter" "$display_text" "$display_info")
        commit_data["$counter"]="$commit_hash|$commit_message|$branch"
        counter=$((counter + 1))
    done < "$updates_file"
    
    if [ ${#menu_items[@]} -eq 0 ]; then
        dialog --msgbox "No updates found." 8 40
        return
    fi
    
    local selection=$(dialog --menu "Available Updates:\n\nSelect an update to install:" 20 100 8 "${menu_items[@]}" 3>&1 1>&2 2>&3)
    
    if [ -n "$selection" ] && [ -n "${commit_data[$selection]}" ]; then
        IFS='|' read -r selected_commit selected_message selected_branch <<< "${commit_data[$selection]}"
        
        # Show confirmation dialog
        local branch_warning=""
        if [[ "$selected_branch" == *"EXPERIMENTAL"* ]]; then
            branch_warning="\n\n  WARNING: This is an experimental branch!\nIt may contain unstable features or bugs."
        fi
        
        if dialog --yesno "Install update?\n\nCommit: ${selected_commit:0:8}\nMessage: $selected_message\nBranch: $selected_branch$branch_warning\n\nThis will update your msc installation." 15 70; then
            install_update "$selected_commit" "$selected_branch"
        fi
    fi
}

# Function to install update
install_update() {
    local commit_hash="$1"
    local branch="$2"
    local clean_branch=$(echo "$branch" | sed 's/ \[EXPERIMENTAL\]//')
    
    {
        echo "10" ; echo "Downloading update..."
        
        # Create temporary directory
        local temp_dir=$(mktemp -d)
        cd "$temp_dir" || exit 1
        
        echo "30" ; echo "Extracting files..."
        
        # Download the specific commit
        if ! curl -L -s "https://github.com/$GITHUB_REPO/archive/$commit_hash.tar.gz" | tar -xz; then
            dialog --msgbox "Failed to download update. Please check your internet connection." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "60" ; echo "Installing files..."
        
        # Find the extracted directory
        local extracted_dir=$(find . -maxdepth 1 -type d -name "*$GITHUB_REPO*" | head -1)
        if [ -z "$extracted_dir" ]; then
            dialog --msgbox "Failed to extract update files." 10 50
            rm -rf "$temp_dir"
            return 1
        fi
        
        echo "80" ; echo "Updating installation..."
        
        # Copy files to installation directory
        cd "$extracted_dir" || exit 1
        sudo cp -r * "$INSTALL_DIR/"
        
        # Make scripts executable
        sudo chmod +x "$INSTALL_DIR/msc" "$INSTALL_DIR/msc-servers.sh" "$INSTALL_DIR/msc-create.sh"
        sudo chmod +x "$INSTALL_DIR/create_scripts/"*.sh
        
        echo "95" ; echo "Saving version info..."
        
        # Save new version
        sudo bash -c "echo '$commit_hash' > '$VERSION_FILE'"
        
        echo "100" ; echo "Update complete!"
        
        # Cleanup
        cd /
        rm -rf "$temp_dir"
        
    } | dialog --gauge "Installing Update..." 10 60 0
    
    dialog --msgbox "Update installed successfully!\n\nNew version: ${commit_hash:0:8}\nBranch: $clean_branch\n\nPlease restart msc to use the new version." 12 60
}

# Function to display the menu
show_menu() {
    dialog --clear --title "Minecraft Server Control" --menu "Choose an option:" 17 55 3 \
        1 "Manage Minecraft Servers" \
        2 "Create a New Minecraft Server" \
        3 "Check for Updates" 2> /tmp/msc_menu_choice

    local choice
    choice=$(< /tmp/msc_menu_choice)
    rm -f /tmp/msc_menu_choice

    case "$choice" in
        1)
            # Run the msc-servers.sh script
            bash msc-servers.sh
            ;;
        2)
            # Run the msc-create.sh script
            bash msc-create.sh
            ;;
        3)
            # Check for updates
            check_for_updates
            ;;
        *)
            # If cancelled or closed, do nothing
            clear
            echo "Exited menu."
            ;;
    esac
}

# Main execution
clear
show_menu
